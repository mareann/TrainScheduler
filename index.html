<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Train Schedule</title>	
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!--  JQUERY  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="assets/css/style.css">
      <!-- Moment.js Reference -->
    <!-- <script src="http://momentjs.com/downloads/moment.js"></script>   -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Table</h2>
    <p>The .table-responsive class creates a responsive table which will scroll horizontally on small devices (under 768px). When viewing on anything larger than 768px wide, there is no difference:</p>                                                                                      
  <divclass="table-responsive">          
    <table  id="trainTable" class="table">
      <thead>
        <tr>
          <th>Train Name</th>
          <th>Destination</th>
          <th>Frequency (min)</th>
          <th>Next Arrival</th>
          <th>Minutes Away</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div> <!-- end table -->

  <form>
  	<h2>Add Train</h2>
    <div class="input-group">
      <span class="input-group-addon">Train Name</span>
      <input id="inputName" type="text" class="form-control" name="msg" placeholder="train name">
    </div>
    <div class="input-group">
      <span class="input-group-addon">Destination&nbsp;</span>
      <input id="inputDest" type="text" class="form-control" name="msg" placeholder="final location">
    </div>
    <div class="input-group">
      <span class="input-group-addon">Train Time&nbsp;&nbsp;</span>
      <input id="inputTime" type="text" class="form-control" name="msg" placeholder="first train time">
    </div>
    <div class="input-group">
      <span class="input-group-addon">Frequency&nbsp;&nbsp;</span>
      <input id="inputFreq" type="text" class="form-control" name="msg" placeholder="Frequency (min)">
    </div>
    <button id="submitButton" type="submit" class="btn btn-default">Submit</button>
</form>
</div> <!-- end container -->
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
<script type="text/javascript">
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAA2-YiZZlPUslvIq03lgC4d5uqdYRDQlQ",
    authDomain: "train-schedule-dee51.firebaseapp.com",
    databaseURL: "https://train-schedule-dee51.firebaseio.com",
    projectId: "train-schedule-dee51",
    storageBucket: "",
    messagingSenderId: "515859285234"
  };

  firebase.initializeApp(config);	
  var database = firebase.database();



 // Adding click event listener
  $("#submitButton").on("click", function(event) {
      event.preventDefault();

     var trainName = $("#inputName").val().trim();
     var trainDest = $("#inputDest").val().trim();
     var trainTime = $("#inputTime").val().trim();
     var trainFreq = $("#inputFreq").val().trim();

     console.log("name "+trainName);
     console.log("dest "+trainDest);
     console.log("time "+trainTime);
     console.log("freq "+trainFreq);

  // Creates local "temporary" object for holding employee data
  var trains = {
    trainName: trainName,
    trainDest: trainDest,
    trainTime: trainTime,
    trainFreq: trainFreq
  };

  // Uploads employee data to the database
  database.ref().push(trains);

  console.log("obj name "+trains.trainName);

  // 3. Create Firebase event for adding employee to the database and a row in the html when a user adds an entry
  database.ref().on("child_added", function(childSnapshot, prevChildKey) {

  console.log("childSnapshot "+childSnapshot.val());

  // Store everything into a variable.
  var trainName = childSnapshot.val().trainName;
  var trainDest = childSnapshot.val().trainDest;
  var trainTime = childSnapshot.val().trainTime;
  var trainFreq = childSnapshot.val().trainFreq;

  // Employee Info
  console.log("db "+trainName);
  console.log(trainDest);
  console.log(trainTime);
  console.log(trainFreq);

  var timeMinToArrive = trainInfoDisplay( trainName, trainDest,trainTime,trainFreq );
  var timeNow = moment();

          // add minutes to arrive to current time
    trainTime = moment(timeNow).add(timeMinToArrive,'m');
    var trainTimeTmp = moment(trainTime).format("hh:mm A");
    // format train time (HH:mm)
    trainTime = moment(trainTime).format("HH:mm");


 // trainTime = moment(timeNow).add(timeMinToArrive).format("HH:mm");
    console.log("timeNow "+timeNow+" timeMinToArrive "+timeMinToArrive);
    console.log("NEW add to table trainTime "+trainTime);
    // Add each train's data into the table
    $("#trainTable > tbody").append("<tr><td>" + trainName + "</td><td>" + trainDest + "</td><td>" + trainFreq + "</td><td>" + trainTime +" ("+trainTimeTmp+") "  + "</td><td>" +timeMinToArrive+"</td></tr>");
 // for ( var i=0;i< (1440/trainFreq);i++)
  //var numOfTrains = (1440/trainFreq);
  //console.log("num of Trains "+numOfTrains);

  //var timePretty = moment(trainTime, 'HH:mm').add(trainFreq,'minutes').format("HH:mm");
  console.log("add table row timePretty "+timePretty);

  // Add each train's data into the table
 //  $("#trainTable > tbody").append("<tr><td>" + trainName + "</td><td>" + trainDest + "</td><td>" + trainFreq + "</td><td>" + trainTime + "</td><td>" +timeMinToArrive+"</td></tr>");
  $("#trainTable > tbody").append("<tr><td>" + trainName + "</td><td>" + trainDest + "</td><td>" +trainFreq + "</td><td>" + timePretty + "</td><td>" +trainFreq+"</td></tr>");
});


  }); // end click
//////////////////////////////////////////////////////
      function trainInfoDisplay( trainName, trainDest,trainTime,trainFreq)
      {
        var trainFirstTime = trainTime;
        var timeMinToArrive = 0;

      // To calculate 
        var now = moment();
        var currentTime = moment(now).format("HH:mm");
        //console.log("currentTime "+currentTime);
        //console.log("trainFreq "+trainFreq);
      
        var numOfTrains = (1440/trainFreq);

    //if (trainName === "Downtown") {
        var trainArrivals = [];
        console.log("=====arrival trainFirstTime "+trainFirstTime+" Freq "+trainFreq+" numOfTrains "+numOfTrains);
        var trainCount = parseInt(numOfTrains/2);
        for (i=0; i< trainCount ;i++)
        {
          var tmp = moment(trainFirstTime,"HH:mm");
          //if(i==1)
            //console.log("tmp trainFirstTime "+moment(tmp).format("HH:mm"));
          var minToAdd = trainFreq*i;
          //trainArrivals[i] = moment(tmp).add(minToAdd,'m').format("HH:mm");
          trainArrivals[i] = moment(tmp).add(minToAdd,'m');
          //if (i==1)
          console.log("trainArrivals["+i+"] "+moment(trainArrivals[i]).format("HH:mm")+" min "+trainArrivals[i]);
          //if (i==1)
          //a.diff(b, 'years', true); // 1.75
          //var timeArrivalMin = moment(trainArrivals[i]).format('m');
          var currentMin = moment(now).format('m');
          //console.log("currentMin "+currentMin);

          var timeDiff = trainArrivals[i].diff(now);
          console.log("trainArrivals "+trainArrivals[i]+" now "+now+" timeDiff "+timeDiff);
          //console.log("timeMin "+timeArrivalMin+" timeDiff "+timeDiff);

          //var timeDiff2 = now.diff(trainArrivals[i]);
          //  console.log("timeDiff2 "+timeDiff2);
          trainTime = moment(trainArrivals[i]).format("HH:mm");
          if ( timeDiff > 0 ) //|| timeDiff2 < 0 )
           {
             timeMinToArrive = moment(timeDiff).format('m');//= Math.round(timeDiff);

             //console.log("timeMin "+timeArrivalMin+" timeDiff "+timeDiff);
             //console.log("timeMinToArrive "+timeMinToArrive);
             //console.log("arrivals "+trainArrivals[i]+" new trainTime "+trainTime);
             i=trainCount;
            
           }
        }
     // }
        return(timeMinToArrive);
    } // end function
///////////////////////////////////////////

    database.ref().on("child_added",function(snapshot){

      //console.log("snap time "+snapshot.val().trainTime);

      var trainName = snapshot.val().trainName;
      var trainDest = snapshot.val().trainDest;
      var trainTime = snapshot.val().trainTime;
    //  var trainFirstTime = snapshot.val().trainTime;
      var trainFreq = snapshot.val().trainFreq;
      var timeMinToArrive = 0;
      var timeNow = moment();
      timeMinToArrive = trainInfoDisplay( trainName, trainDest,trainTime,trainFreq );

    // add minutes to arrive to current time
    trainTime = moment(timeNow).add(timeMinToArrive,'m');
    var trainTimeTmp = moment(trainTime).format("hh:mm A");
    // format train time (HH:mm)
    trainTime = moment(trainTime).format("HH:mm");


 // trainTime = moment(timeNow).add(timeMinToArrive).format("HH:mm");
    console.log("timeNow "+timeNow+" timeMinToArrive "+timeMinToArrive);
    console.log("diff add to table trainTime "+trainTime);
    // Add each train's data into the table
    $("#trainTable > tbody").append("<tr><td>" + trainName + "</td><td>" + trainDest + "</td><td>" + trainFreq + "</td><td>" + trainTime +" ("+trainTimeTmp+") "  + "</td><td>" +timeMinToArrive+"</td></tr>");
  });
</script>	
</body>
</html>